<html>
    <head>
        <meta charset="UTF-8">
        <!-- blank favicon to supress extra request-->
        <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQEAYAAABPYyMiAAAABmJLR0T///////8JWPfcAAAACXBIWXMAAABIAAAASABGyWs+AAAAF0lEQVRIx2NgGAWjYBSMglEwCkbBSAcACBAAAeaR9cIAAAAASUVORK5CYII=">
        <script src="js/elementary.js"></script>
        <script src="js/kvetch.js"></script>
        <script src="js/propmodified.js"></script>
        <script src="js/controlpanel.js"></script>
        <!-- <script src="js/shiftspace.js"></script> -->
    
        <script src="js/geodesyUtil.js" defer="true"></script>
        <!-- <script src="js/outTurf.js" defer="true"></script> -->

        <script src="templates/formStyle.js"></script> <!--global stylesheet for all forms -->
        <script src="templates/motifStyle.js"></script> <!-- global stylesheet for all geodesy motifs-->
        <script src="templates/normTemplate.js"></script> <!-- generates polygons and targets-->
        <script src="templates/radioLayerTemplate.js"></script> <!-- generates polygons and targets-->
        <script src="templates/formLayerTemplate.js"></script> <!--a template to generate forms -->
        <script src="templates/formPropsTemplate.js"></script> <!--a template to generate forms -->

    </head>
    <body>
        <script>
            window.cache = {}
            Promise.all([
                kvetch.get(`cache/square.json`).then(res => window.cache.square = res),
                kvetch.get(`cache/pyritohedron.json`).then(res => window.cache.pyritohedron = res),
                kvetch.get(`cache/honeycomb.json`).then(res => window.cache.honeycomb = res),
                kvetch.get(`cache/p4octagon.json`).then(res => window.cache.p4octagon = res)
            ]).then(()=>{
                document.head.appendChild(createElementary([
                    templates.motifStyle(), // uses window.cache and generates stylesheet, attaches to head
                    templates.formStyle()
                ]))

                document.body.appendChild(controlpanel(
                    templates.formLayerTemplate(),
                    { props: { id: 'formlayers', target: 'formprops'}}
                ))
                document.getElementById('formlayers')
                        .addEventListener('submit', function(event){
                            event.preventDefault()
                            let geoid = geodesy.getRandomID()
                            let formElement = document.getElementById(this.props.target)
                            let geodesyElement = createElementary(
                                {'x-geodesy': {id: geoid}}
                            ).querySelector('x-geodesy')

                            document.body.appendChild(geodesyElement)
                            geodesyElement.addEventListener('propModified', geodesy.propModified)
                            geodesyElement.props = formElement.formprops
                            // after the geodesyElement has its props applied, change the target of the form
                            formElement.props.target = geoid // triggers form reflow

                            let radioElement = createElementary(
                                templates.radioLayerTemplate(geoid)
                            ).querySelector('section')  

                            this.prepend(radioElement)
                            
                            geodesyElement.addEventListener('propModified', event => {
                                if(event.detail.propName == 'title'){
                                    radioElement.querySelector('fieldset').textContent = event.detail.newValue || "untitled"
                                }
                            })

                        })
                document.body.appendChild(controlpanel(
                    templates.formPropsTemplate(),
                    { props: { id: 'formprops' }}
                ))
                document.getElementById('formprops')
                        .addEventListener('propModified', function({detail}){
                            console.log("formprops now has new target", detail)
                            // should update the form to the state of the newly targeted geodesy
                            let {propName, oldValue, newValue} = detail

                            if(propName == 'target' && newValue != oldValue){
                                let newtarget = document.getElementById(newValue)
                                if(newtarget){
                                    this.formprops = newtarget.props
                                } else {
                                    this.props.target = "" // empty string so Boolean(this.props.target) is false
                                    throw new Error("Received a target that doesn't exist")
                                }
                            }
                        })
            }) // end .then()
        </script>
    </body>
</html>